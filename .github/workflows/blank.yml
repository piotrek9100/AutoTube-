# This is a basic workflowname: Build AutoTube APK

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Install Android SDK tools
        run: |
          sudo apt-get update -y
          sudo apt-get install -y unzip zip wget
          mkdir -p $HOME/android-sdk
          cd $HOME/android-sdk
          wget -q https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip -O cmdline.zip
          unzip -q cmdline.zip -d cmdline
          yes | cmdline/cmdline-tools/bin/sdkmanager --sdk_root=$HOME/android-sdk "platform-tools" "platforms;android-31" "build-tools;34.0.0"
      - name: Show java
        run: java -version

      - name: Prepare apktool
        run: |
          if [ ! -f apktool.jar ]; then
            echo "apktool.jar missing in repo. You can add it or modify workflow to download."
            exit 1
          fi

      - name: Build with apktool
        run: |
          java -jar apktool.jar b fermata_src_modified -o unsigned.apk

      - name: Zipalign
        run: |
          ${HOME}/android-sdk/build-tools/34.0.0/zipalign -v -p 4 unsigned.apk unsigned-aligned.apk

      - name: Prepare debug keystore
        run: |
          printf 'android' > /tmp/dummy && \
          keytool -genkeypair -v -keystore debug.keystore -alias androiddebugkey -storepass android -keypass android -dname "CN=Android Debug,O=Android,C=US" -keyalg RSA -keysize 2048 -validity 10000

      - name: Sign APK
        run: |
          ${HOME}/android-sdk/build-tools/34.0.0/apksigner sign --ks debug.keystore --ks-pass pass:android --key-pass pass:android --out AutoTube-1.0.apk unsigned-aligned.apk

      - name: Verify
        run: ${HOME}/android-sdk/build-tools/34.0.0/apksigner verify --print-certs AutoTube-1.0.apk

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: AutoTube-APK
          path: AutoTube-1.0.apk to help you get started with Actions

name: CI

# Controls when the workflow will run
on:
  # Triggers the workflow on push or pull request events but only for the "main" branch
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  build:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v4

      # Runs a single command using the runners shell
      - name: Run a one-line script
        run: echo Hello, world!

      # Runs a set of commands using the runners shell
      - name: Run a multi-line script
        run: |
          echo Add other actions to build,
          echo test, and deploy your project.
